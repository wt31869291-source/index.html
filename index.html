<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç²‰å«©å¥åº·ç®¡å®¶ v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --soft-pink: #fffafa; --accent-red: #ff4d6d; }
        body { background-color: var(--soft-pink); font-family: -apple-system, sans-serif; overflow-x: hidden; }
        body.modal-open { overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .day-cell { min-height: 80px; background: white; border-radius: 16px; border: 1px solid #ffe4e8; position: relative; }
        .today-border { border: 2px solid var(--accent-red) !important; box-shadow: 0 0 10px rgba(255, 77, 109, 0.2); }
        .period-dot { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #ff8fa3; border-radius: 50%; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; padding: 15px; overflow-y: auto; align-items: flex-start; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 400px; border-radius: 32px; margin: auto; overflow: hidden; position: relative; }
        .estimate-tag { cursor: pointer; background: #fff0f3; color: #ff4d6d; padding: 4px 10px; border-radius: 99px; font-size: 11px; margin: 4px 2px; display: inline-block; border: 1px solid #ffccd5; }
        input[type="number"], input[type="text"] { -webkit-appearance: none; border-radius: 12px; }
    </style>
</head>
<body class="text-gray-700">

    <div class="max-w-md mx-auto min-h-screen bg-white">
        <div class="p-6 bg-[#ffeef2] rounded-b-[40px] shadow-sm">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black text-[#ff4d6d]">ğŸŒ¸ Daily Health</h1>
                    <p id="topDate" class="text-xs text-pink-400 font-medium"></p>
                </div>
                <div class="bg-white/80 px-4 py-2 rounded-2xl text-center shadow-sm">
                    <p class="text-[10px] text-pink-500 font-bold uppercase">ç›®å‰é«”é‡</p>
                    <p id="topCurrentWeight" class="text-xl font-black text-gray-700">--</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-4 text-center">
                <div class="bg-white/60 p-3 rounded-2xl">
                    <p class="text-[10px] text-pink-400 font-bold">å‰©é¤˜ç†±é‡</p>
                    <p id="topRemain" class="text-lg font-black text-orange-500">--</p>
                </div>
                <div class="bg-white/60 p-3 rounded-2xl">
                    <p id="topAdviceTitle" class="text-[10px] text-pink-400 font-bold">é£²é£Ÿå»ºè­°</p>
                    <p id="topAdvice" class="text-[10px] leading-tight text-gray-500 mt-1 italic">æ­£åœ¨åˆ†ææ•¸æ“š...</p>
                </div>
            </div>
        </div>

        <div class="p-4">
            <div class="flex justify-between items-center px-4 mb-4 text-[#ff4d6d] font-bold text-lg">
                <button onclick="changeMonth(-1)">â—€</button>
                <h2 id="monthTitle">2026å¹´ 1æœˆ</h2>
                <button onclick="changeMonth(1)">â–¶</button>
            </div>
            <div class="calendar-grid text-center text-[11px] text-pink-300 font-bold mb-2">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarBody" class="calendar-grid"></div>
        </div>
    </div>

    <div id="recordModal" class="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal-content animate-slide-up">
            <div class="p-5 bg-[#ffeef2] flex justify-between items-center border-b border-pink-100">
                <h3 id="modalDateTitle" class="font-bold text-[#ff4d6d]">æ—¥æœŸç´€éŒ„</h3>
                <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center bg-white rounded-full text-[#ff4d6d] shadow-sm">âœ•</button>
            </div>
            
            <div class="p-5 space-y-6 overflow-y-auto" style="max-height: 75vh;">
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <label class="font-bold text-pink-600">ğŸ± é£²é£Ÿç†±é‡</label>
                        <span id="modalDayTotal" class="text-sm font-black text-orange-500">0 kcal</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="foodIn" oninput="showEstimate(this.value)" placeholder="è¼¸å…¥é£Ÿç‰©é—œéµå­—..." class="flex-1 p-3 bg-gray-50 rounded-2xl text-sm focus:bg-pink-50 transition-colors border-none outline-none">
                        <input type="number" id="calIn" placeholder="kcal" class="w-20 p-3 bg-gray-50 rounded-2xl text-sm border-none outline-none">
                        <button onclick="saveFood()" id="foodBtn" class="bg-[#ff4d6d] text-white px-4 rounded-2xl text-sm font-bold">åŠ </button>
                    </div>
                    <div id="estimateBox" class="flex flex-wrap"></div>
                    <div id="foodList" class="space-y-2"></div>
                </div>

                <div class="p-4 bg-pink-50 rounded-3xl space-y-3">
                    <div class="flex justify-between items-center">
                        <label class="font-bold text-pink-600">âš–ï¸ é«”é‡ç´€éŒ„</label>
                        <span id="weightDiff" class="text-[10px] bg-white px-2 py-1 rounded-full text-pink-400 font-bold">æ³¢å‹•: --</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1 text-center">
                            <span class="text-[10px] text-pink-300">èµ·åºŠç©ºè…¹</span>
                            <input type="number" id="w1" placeholder="kg" class="w-full p-2 rounded-xl border-none text-center text-lg font-bold">
                        </div>
                        <div class="space-y-1 text-center">
                            <span class="text-[10px] text-pink-300">ç¡å‰ç´€éŒ„</span>
                            <input type="number" id="w2" placeholder="kg" class="w-full p-2 rounded-xl border-none text-center text-lg font-bold">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-blue-50 rounded-3xl">
                        <label class="block text-xs font-bold text-blue-500 mb-2">ğŸ’§ é£²æ°´ (ml)</label>
                        <input type="number" id="waterIn" placeholder="ç¸½é‡" class="w-full p-2 rounded-xl border-none text-center font-bold">
                    </div>
                    <div class="p-4 bg-red-50 rounded-3xl flex flex-col justify-center items-center">
                        <label class="text-xs font-bold text-red-400 mb-2">ğŸˆ ç”Ÿç†æœŸ</label>
                        <input type="checkbox" id="pCheck" class="w-6 h-6 accent-red-400">
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="font-bold text-green-600">ğŸƒ é‹å‹•é …ç›®</label>
                    <input type="text" id="exSearch" onkeyup="filterEx()" placeholder="æœå°‹éƒ¨ä½æˆ–åç¨±..." class="w-full p-3 bg-gray-50 rounded-2xl text-sm border-none outline-none">
                    <div id="exList" class="space-y-2 max-h-48 overflow-y-auto pr-2"></div>
                </div>
            </div>
            
            <div class="p-5 bg-white border-t border-gray-100">
                <button onclick="finalSave()" class="w-full bg-[#ff4d6d] text-white py-4 rounded-[20px] font-bold shadow-lg shadow-pink-100 active:scale-95 transition-transform">ç¢ºèªå„²å­˜</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear, currentMonth, activeDate = "", dailyFoods = [], editIndex = -1;
        const calDict = { "æ’éª¨é£¯": 850, "é›è‚‰é£¯": 450, "ç‰›è‚‰éºµ": 650, "æ»·è‚‰é£¯": 500, "ç‡™é’èœ": 50, "çå¥¶": 650, "é›æ’": 750, "è›‹é¤…": 300, "ä¸‰æ˜æ²»": 350, "ä¹¾éºµ": 500, "ç«é‹": 1000, "ä¾¿ç•¶": 800, "æ°´é¤ƒ": 500, "åœ°ç“œ": 150, "é›èƒ¸è‚‰": 160, "é¦™è•‰": 90, "æ‹¿éµ": 150 };
        const exercises = ["å•éˆ´è² é‡æ·±è¹².è…¿è‡€", "å•éˆ´å¤¾èƒ¸.èƒ¸", "å•éˆ´åˆ’èˆ¹.èƒŒ", "å·¦å³å´æŠ¬è…¿.è…¿", "è·ªå¼å‰å¾Œä¿¯è‡¥æ’.è…¹", "ä¿¯è‡¥å¾ŒæŠ¬è…¿.è‡€", "è…³å¿ƒé–‹åˆ.è…¿", "è·ªå§¿å·¦å³æŠ¬è…¿.è…°è…¹", "è·ªå§¿å¾ŒæŠ¬è…¿(ç›´).ä¸‹è‡€", "è·ªå§¿å½æ›²æŠ¬è…¿.ä¸Šè‡€", "å•éˆ´wå¤–æ¨.æ‰‹è‡‚", "è‡€æ©‹.è‡€", "å•éˆ´å´å¹³èˆ‰.è‚©", "å•éˆ´ç¡¬æ‹‰.è‡€", "å½ˆåŠ›å¸¶å‰å¾Œç¹è‚©.è‚©èƒŒ", "å½ˆåŠ›å¸¶é«˜ä½ä¸‹æ‹‰.è‚©èƒŒ", "å½ˆåŠ›å¸¶å·¦å³å´æ‹‰.æ‰‹èƒ¸", "å·¦å³è…¿åˆ†è¹².è‡€", "è…³å°–äº¤å‰é»åœ°.è…¹", "äº¤æ›¿æ”¶è…¿.è…¹", "å±ˆè†æ²è…¹.è…¹", "ç›´è…¿æ²è…¹.è…¹", "è‡ªè¡Œè»Šæ²è…¹.è…¹", "å‰ªåˆ€è…¿.è…¹"];

        window.onload = () => {
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            renderCalendar();
            renderExList();
            updateTopUI();
        };

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            document.getElementById('monthTitle').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            document.getElementById('topDate').innerText = new Date().toLocaleDateString();
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const periodStart = localStorage.getItem('period_start');
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < firstDay; i++) body.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = JSON.parse(localStorage.getItem('health_' + dateStr));
                let classes = 'day-cell p-2 cursor-pointer transition-all active:scale-95';
                if(dateStr === todayStr) classes += ' today-border';
                
                let pTag = '';
                if(periodStart) {
                    const diff = (new Date(dateStr) - new Date(periodStart)) / (1000*60*60*24);
                    if(diff >= 0 && diff < 7) pTag = `<div class="period-dot"></div>`;
                }

                body.innerHTML += `<div class="${classes}" onclick="openModal('${dateStr}')">
                    <span class="text-xs font-black text-pink-400">${d}</span>
                    ${data && data.totalCal ? `<div class="text-[9px] text-orange-400 font-bold mt-1">${data.totalCal}k</div>` : ''}
                    ${data && data.w1 ? `<div class="text-[9px] text-gray-500 font-medium">${data.w1}</div>` : ''}
                    ${pTag}
                </div>`;
            }
        }

        function openModal(date) {
            activeDate = date;
            document.getElementById('modalDateTitle').innerText = date;
            const data = JSON.parse(localStorage.getItem('health_' + date)) || {};
            document.getElementById('w1').value = data.w1 || '';
            document.getElementById('w2').value = data.w2 || '';
            document.getElementById('waterIn').value = data.water || '';
            document.getElementById('pCheck').checked = (localStorage.getItem('period_start') === date);
            dailyFoods = data.foods || [];
            updateFoodUI();
            calculateWeightDiff();
            document.getElementById('recordModal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('recordModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            activeDate = "";
        }

        function handleOverlayClick(e) { if(e.target.id === 'recordModal') closeModal(); }

        function showEstimate(val) {
            const box = document.getElementById('estimateBox');
            box.innerHTML = '';
            if(!val) return;
            for(let k in calDict) {
                if(k.includes(val)) {
                    box.innerHTML += `<div class="estimate-tag" onclick="useEst('${k}', ${calDict[k]})">${k} ${calDict[k]}k</div>`;
                }
            }
        }

        function useEst(n, c) {
            document.getElementById('foodIn').value = n;
            document.getElementById('calIn').value = c;
            document.getElementById('estimateBox').innerHTML = '';
        }

        function saveFood() {
            const n = document.getElementById('foodIn').value || "é£Ÿç‰©";
            const c = parseInt(document.getElementById('calIn').value) || 0;
            if(editIndex > -1) dailyFoods[editIndex] = {name: n, cal: c};
            else dailyFoods.push({name: n, cal: c});
            editIndex = -1;
            document.getElementById('foodIn').value = "";
            document.getElementById('calIn').value = "";
            document.getElementById('foodBtn').innerText = "åŠ ";
            updateFoodUI();
        }

        function updateFoodUI() {
            const list = document.getElementById('foodList');
            let total = 0;
            list.innerHTML = dailyFoods.map((f, i) => {
                total += f.cal;
                return `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-2xl text-xs">
                    <span class="font-medium">${f.name} <b class="text-orange-500 ml-1">${f.cal}</b></span>
                    <div class="flex gap-3">
                        <button onclick="editF(${i})" class="text-blue-400 font-bold">ç·¨è¼¯</button>
                        <button onclick="delF(${i})" class="text-red-300 font-bold">åˆªé™¤</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('modalDayTotal').innerText = total + " kcal";
        }

        function editF(i) {
            editIndex = i;
            document.getElementById('foodIn').value = dailyFoods[i].name;
            document.getElementById('calIn').value = dailyFoods[i].cal;
            document.getElementById('foodBtn').innerText = "ç¢ºèª";
            document.getElementById('foodIn').focus();
        }

        function delF(i) { dailyFoods.splice(i, 1); updateFoodUI(); }

        function calculateWeightDiff() {
            const w1 = parseFloat(document.getElementById('w1').value);
            const w2 = parseFloat(document.getElementById('w2').value);
            const diffEl = document.getElementById('weightDiff');
            if(w1 && w2) {
                const diff = (w2 - w1).toFixed(1);
                diffEl.innerText = `ä»Šæ—¥æ³¢å‹•: ${diff > 0 ? '+' : ''}${diff} kg`;
            } else {
                diffEl.innerText = `æ³¢å‹•: --`;
            }
        }

        document.getElementById('w1').onchange = calculateWeightDiff;
        document.getElementById('w2').onchange = calculateWeightDiff;

        function finalSave() {
            const totalCal = dailyFoods.reduce((s, f) => s + f.cal, 0);
            const data = {
                totalCal, foods: dailyFoods,
                w1: document.getElementById('w1').value,
                w2: document.getElementById('w2').value,
                water: document.getElementById('waterIn').value
            };
            localStorage.setItem('health_' + activeDate, JSON.stringify(data));
            if(document.getElementById('pCheck').checked) localStorage.setItem('period_start', activeDate);
            else if(localStorage.getItem('period_start') === activeDate) localStorage.removeItem('period_start');
            closeModal();
            renderCalendar();
            updateTopUI();
        }

        function updateTopUI() {
            const todayStr = new Date().toISOString().split('T')[0];
            const data = JSON.parse(localStorage.getItem('health_' + todayStr)) || {};
            const periodStart = localStorage.getItem('period_start');
            let tdee = 1800;
            if(periodStart) {
                const diff = (new Date(todayStr) - new Date(periodStart)) / (1000*60*60*24);
                if(diff >= 0 && diff < 7) tdee += 200;
            }
            const remain = tdee - (data.totalCal || 0);
            document.getElementById('topRemain').innerText = remain + " kcal";
            document.getElementById('topCurrentWeight').innerText = (data.w1 || "--") + " kg";
            
            const adEl = document.getElementById('topAdvice');
            if(remain > 800) adEl.innerText = "é ç®—å……è¶³ï¼Œæ¨è–¦è£œå……è›‹ç™½è³ª";
            else if(remain > 400) adEl.innerText = "é ç®—ä¸€èˆ¬ï¼Œå»ºè­°è¼•é£Ÿç‚ºä¸»";
            else if(remain > 0) adEl.innerText = "é ç®—åƒç·Šï¼Œæ™šé¤åƒæ²™æ‹‰å§";
            else adEl.innerText = "å·²é”æ¨™ï¼Œå¤šå–æ°´ä»£è¬å”·";
        }

        function renderExList() {
            const list = document.getElementById('exList');
            list.innerHTML = exercises.map(ex => {
                const [n, p] = ex.split('.');
                return `<div class="ex-item flex justify-between items-center p-3 bg-white border border-pink-50 rounded-2xl shadow-sm" data-key="${ex}">
                    <div class="text-xs"><b class="text-gray-700">${n}</b><br><span class="text-pink-300 text-[9px]">${p}</span></div>
                    <div class="flex gap-2 items-center text-xs"><input type="number" placeholder="ä¸‹" class="w-10 p-1 bg-pink-50 rounded text-center">x<input type="number" placeholder="çµ„" class="w-10 p-1 bg-pink-50 rounded text-center"></div>
                </div>`;
            }).join('');
        }

        function filterEx() {
            const q = document.getElementById('exSearch').value.toLowerCase();
            document.querySelectorAll('.ex-item').forEach(el => {
                el.style.display = el.dataset.key.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        }

        function changeMonth(s) {
            currentMonth += s;
            if(currentMonth > 11) { currentMonth = 0; currentYear++; }
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }
    </script>
</body>
</html>

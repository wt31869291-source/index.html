<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Á≤âÂ´©ÂÅ•Â∫∑ÁÆ°ÂÆ∂ v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --soft-pink: #fffbfc; --accent-red: #ff4d6d; --date-text: #5a4a4a; }
        body { background-color: var(--soft-pink); font-family: -apple-system, "Microsoft JhengHei", sans-serif; overflow-x: hidden; color: #4a4a4a; }
        body.modal-open { overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { min-height: 85px; background: white; border-radius: 18px; border: 1px solid #ffeef0; position: relative; transition: 0.2s; }
        .today-border { border: 2.5px solid var(--accent-red) !important; background: #fff5f6; }
        .date-num { color: var(--date-text); font-weight: 800; font-size: 13px; }
        .period-dot { position: absolute; top: 6px; right: 6px; width: 8px; height: 8px; background: #ff8fa3; border-radius: 50%; box-shadow: 0 0 4px #ffb6c1; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 50; padding: 15px; overflow-y: auto; align-items: flex-start; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 420px; border-radius: 35px; margin: auto; overflow: hidden; position: relative; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.1); }
        .estimate-tag { cursor: pointer; background: #fff0f3; color: #ff4d6d; padding: 5px 12px; border-radius: 15px; font-size: 12px; margin: 4px; display: inline-block; border: 1px solid #ffccd5; transition: 0.2s; }
        .estimate-tag:active { background: #ffccd5; }
        input { border: 1px solid #f0f0f0 !important; }
        input:focus { outline: none; border-color: #ffccd5 !important; background: #fffafb; }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto min-h-screen bg-white shadow-inner">
        <div class="p-8 bg-gradient-to-b from-[#ffeef2] to-white rounded-b-[50px]">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-2xl font-black text-[#ff4d6d] tracking-tight">üå∏ My Health Log</h1>
                    <p id="topDate" class="text-[11px] text-pink-400 font-bold tracking-widest uppercase"></p>
                </div>
                <div class="bg-white px-5 py-3 rounded-[25px] text-center shadow-sm border border-pink-50">
                    <p class="text-[10px] text-pink-400 font-black mb-1">CURRENT</p>
                    <p id="topCurrentWeight" class="text-2xl font-black text-[#5a4a4a]">--</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 text-center">
                <div class="bg-white/80 p-4 rounded-[25px] border border-pink-50 shadow-sm">
                    <p class="text-[10px] text-pink-400 font-bold mb-1">Ââ©È§òÁÜ±Èáè</p>
                    <p id="topRemain" class="text-xl font-black text-orange-400">--</p>
                </div>
                <div class="bg-white/80 p-4 rounded-[25px] border border-pink-50 shadow-sm flex items-center justify-center">
                    <p id="topAdvice" class="text-[11px] leading-snug text-gray-500 font-medium italic"></p>
                </div>
            </div>
        </div>

        <div class="p-5">
            <div class="flex justify-between items-center px-4 mb-6">
                <button onclick="changeMonth(-1)" class="text-pink-200 hover:text-pink-400">‚óÄ</button>
                <h2 id="monthTitle" class="font-black text-[#5a4a4a] text-lg tracking-tighter"></h2>
                <button onclick="changeMonth(1)" class="text-pink-200 hover:text-pink-400">‚ñ∂</button>
            </div>
            <div class="calendar-grid text-center text-[10px] text-pink-300 font-black mb-3 tracking-widest">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarBody" class="calendar-grid"></div>
        </div>
    </div>

    <div id="recordModal" class="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal-content animate-slide-up">
            <div class="p-6 bg-[#ffeef2] flex justify-between items-center">
                <h3 id="modalDateTitle" class="font-black text-[#ff4d6d] text-lg"></h3>
                <button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-white rounded-full text-[#ff4d6d] shadow-sm font-bold">‚úï</button>
            </div>
            
            <div class="p-6 space-y-8 overflow-y-auto" style="max-height: 70vh;">
                <div class="space-y-4">
                    <div class="flex justify-between items-end px-1">
                        <label class="font-black text-[#5a4a4a] flex items-center gap-2">üç∞ È£≤È£üËàáÁÜ±Èáè</label>
                        <span id="modalDayTotal" class="text-lg font-black text-orange-500">0 <small class="text-[10px]">kcal</small></span>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="foodIn" oninput="showEstimate(this.value)" placeholder="Ëº∏ÂÖ•È£üÁâ©..." class="flex-1 p-4 bg-gray-50 rounded-[20px] text-sm border-none">
                        <input type="number" id="calIn" placeholder="kcal" class="w-24 p-4 bg-gray-50 rounded-[20px] text-sm border-none">
                        <button onclick="saveFood()" id="foodBtn" class="bg-[#ff4d6d] text-white px-6 rounded-[20px] font-bold text-sm">Âä†</button>
                    </div>
                    <div id="estimateBox" class="flex flex-wrap px-1"></div>
                    <div id="foodList" class="space-y-2"></div>
                </div>

                <div class="p-5 bg-[#fff9fa] rounded-[30px] border border-pink-50 shadow-inner">
                    <div class="flex justify-between items-center mb-4">
                        <label class="font-black text-[#5a4a4a]">‚öñÔ∏è È´îÈáçÁõ£Ê∏¨</label>
                        <span id="weightDiff" class="text-[10px] bg-white px-3 py-1 rounded-full text-pink-400 font-bold border border-pink-50">Ê≥¢Âãï: --</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <input type="time" id="t1" class="w-full text-[10px] text-center bg-transparent text-pink-300">
                            <input type="number" step="0.1" id="w1" placeholder="Á¥ÄÈåÑ 1" class="w-full p-3 rounded-[15px] text-center font-black text-lg text-gray-600">
                        </div>
                        <div class="space-y-2">
                            <input type="time" id="t2" class="w-full text-[10px] text-center bg-transparent text-pink-300">
                            <input type="number" step="0.1" id="w2" placeholder="Á¥ÄÈåÑ 2" class="w-full p-3 rounded-[15px] text-center font-black text-lg text-gray-600">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-5 bg-blue-50/50 rounded-[30px] border border-blue-50">
                        <label class="block text-xs font-black text-blue-400 mb-3">üíß È£≤Ê∞¥ (ml)</label>
                        <input type="number" id="waterIn" class="w-full p-3 rounded-[15px] border-none text-center font-black text-blue-600">
                    </div>
                    <div class="p-5 bg-red-50/50 rounded-[30px] border border-red-50 flex flex-col items-center">
                        <label class="text-xs font-black text-red-400 mb-3">üéà ÁîüÁêÜÊúü</label>
                        <input type="checkbox" id="pCheck" class="w-8 h-8 accent-red-400">
                    </div>
                </div>

                <div class="space-y-4">
                    <label class="font-black text-[#5a4a4a] px-1">üèÉ ÈÅãÂãïË®àÁï´</label>
                    <input type="text" id="exSearch" oninput="filterEx()" placeholder="Áõ¥Êé•ÊêúÂ∞ãÈÅãÂãïÈ†ÖÁõÆ..." class="w-full p-4 bg-gray-50 rounded-[20px] text-sm border-none">
                    <div id="exList" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
                </div>
            </div>
            
            <div class="p-6 bg-white border-t border-gray-50">
                <button onclick="finalSave()" class="w-full bg-[#ff4d6d] text-white py-5 rounded-[25px] font-black shadow-lg shadow-pink-100 active:scale-[0.98] transition-all">ÂÑ≤Â≠ò‰ªäÊó•Êï∏Êìö</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear, currentMonth, activeDate = "", dailyFoods = [], editIndex = -1;
        
        // Êì¥ÂÖÖÂ≠óÂÖ∏
        const calDict = {
            "ÊéíÈ™®È£Ø":850,"ÈõûËÇâÈ£Ø":450,"ÁâõËÇâÈ∫µ":650,"Êª∑ËÇâÈ£Ø":500,"ÁáôÈùíËèú":50,"ÁèçÂ•∂":650,"ÈõûÊéí":750,"ËõãÈ§Ö":300,"‰∏âÊòéÊ≤ª":350,"Ëµ∑Âè∏Ëõã‰∏âÊòéÊ≤ª":420,"ÈÆ™È≠ö‰∏âÊòéÊ≤ª":380,"Êº¢Â†°":450,"Âç°ÊãâÈõûËÖøÂ†°":650,"ÁâõËÇâÂ†°":550,"Ë±¨ËÇâÊªøÁ¶èÂ†°":380,"‰πæÈ∫µ":500,"ÁÅ´Èçã":1000,"‰æøÁï∂":800,"Ê∞¥È§É":500,"Âú∞Áìú":150,"ÈõûËÉ∏ËÇâ":160,"È¶ôËïâ":90,"ÊãøÈêµ":150,
            "Â∑ßÂÖãÂäõËõãÁ≥ï":450,"Ëµ∑Âè∏ËõãÁ≥ï":350,"Ê≥¢Â£´È†ìÊ¥æ":300,"ÊàöÈ¢®ËõãÁ≥ï":250,"Ëè†ËòøÈ∫µÂåÖ":400,"Á¥ÖË±ÜÈ∫µÂåÖ":320,"Â•∂Ê≤πÈ∫µÂåÖ":350,"ÂèØÈ†å":350,"ÂêêÂè∏":150,"ÂéöÁâáÂêêÂè∏":280,"Ë≤ùÊûú":280,"ÁîúÁîúÂúà":300,"ÁÜ±Áãó":250,"ËñØÊ¢ù":350,"ÈõûÂ°ä":300,"Áæ©Â§ßÂà©È∫µ":600,"ÁáâÈ£Ø":700,"Âá±ÊííÊ≤ôÊãâ":350
        };

        const exercises = ["ÂïûÈà¥Ë≤†ÈáçÊ∑±Ëπ≤.ËÖøËáÄ","ÂïûÈà¥Â§æËÉ∏.ËÉ∏","ÂïûÈà¥ÂàíËàπ.ËÉå","Â∑¶Âè≥ÂÅ¥Êä¨ËÖø.ËÖø","Ë∑™ÂºèÂâçÂæå‰øØËá•Êíê.ËÖπ","‰øØËá•ÂæåÊä¨ËÖø.ËáÄ","ËÖ≥ÂøÉÈñãÂêà.ËÖø","Ë∑™ÂßøÂ∑¶Âè≥Êä¨ËÖø.ËÖ∞ËÖπ","Ë∑™ÂßøÂæåÊä¨ËÖø(Áõ¥).‰∏ãËáÄ","Ë∑™ÂßøÂΩéÊõ≤Êä¨ËÖø.‰∏äËáÄ","ÂïûÈà¥wÂ§ñÊé®.ÊâãËáÇ","ËáÄÊ©ã.ËáÄ","ÂïûÈà¥ÂÅ¥Âπ≥Ëàâ.ËÇ©","ÂïûÈà¥Á°¨Êãâ.ËáÄ","ÂΩàÂäõÂ∏∂ÂâçÂæåÁπûËÇ©.ËÇ©ËÉå","ÂΩàÂäõÂ∏∂È´ò‰Ωç‰∏ãÊãâ.ËÇ©ËÉå","ÂΩàÂäõÂ∏∂Â∑¶Âè≥ÂÅ¥Êãâ.ÊâãËÉ∏","Â∑¶Âè≥ËÖøÂàÜËπ≤.ËáÄ","ËÖ≥Â∞ñ‰∫§ÂèâÈªûÂú∞.ËÖπ","‰∫§ÊõøÊî∂ËÖø.ËÖπ","Â±àËÜùÊç≤ËÖπ.ËÖπ","Áõ¥ËÖøÊç≤ËÖπ.ËÖπ","Ëá™Ë°åËªäÊç≤ËÖπ.ËÖπ","Ââ™ÂàÄËÖø.ËÖπ"];

        window.onload = () => {
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            renderCalendar();
            updateTopUI();
        };

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            document.getElementById('monthTitle').innerText = `${currentYear}Âπ¥ ${currentMonth + 1}Êúà`;
            document.getElementById('topDate').innerText = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const periodStart = localStorage.getItem('period_start');
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < firstDay; i++) body.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = JSON.parse(localStorage.getItem('health_' + dateStr));
                let classes = 'day-cell p-3 cursor-pointer active:scale-95';
                if(dateStr === todayStr) classes += ' today-border';
                
                let pTag = '';
                if(periodStart) {
                    const diff = (new Date(dateStr) - new Date(periodStart)) / (1000*60*60*24);
                    if(diff >= 0 && diff < 7) pTag = `<div class="period-dot"></div>`;
                }

                body.innerHTML += `<div class="${classes}" onclick="openModal('${dateStr}')">
                    <span class="date-num">${d}</span>
                    ${data && data.totalCal ? `<div class="text-[9px] text-orange-400 font-black mt-2 leading-none">${data.totalCal}</div>` : ''}
                    ${data && data.w1 ? `<div class="text-[9px] text-pink-300 font-bold mt-1 leading-none">${data.w1}</div>` : ''}
                    ${pTag}
                </div>`;
            }
        }

        function openModal(date) {
            activeDate = date;
            document.getElementById('modalDateTitle').innerText = date;
            const data = JSON.parse(localStorage.getItem('health_' + date)) || {};
            document.getElementById('w1').value = data.w1 || '';
            document.getElementById('w2').value = data.w2 || '';
            document.getElementById('t1').value = data.t1 || '08:00';
            document.getElementById('t2').value = data.t2 || '22:00';
            document.getElementById('waterIn').value = data.water || '';
            document.getElementById('pCheck').checked = (localStorage.getItem('period_start') === date);
            dailyFoods = data.foods || [];
            updateFoodUI();
            calculateWeightDiff();
            filterEx(); // ÈáçÁΩÆÈÅãÂãïÂàóË°®
            document.getElementById('recordModal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function showEstimate(val) {
            const box = document.getElementById('estimateBox');
            box.innerHTML = '';
            if(!val) return;
            const matches = Object.keys(calDict).filter(k => k.includes(val));
            matches.slice(0, 5).forEach(m => {
                box.innerHTML += `<div class="estimate-tag" onclick="useEst('${m}', ${calDict[m]})">${m} ${calDict[m]}k</div>`;
            });
        }

        function useEst(n, c) {
            document.getElementById('foodIn').value = n;
            document.getElementById('calIn').value = c;
            document.getElementById('estimateBox').innerHTML = '';
        }

        function saveFood() {
            const n = document.getElementById('foodIn').value || "È£üÁâ©";
            const c = parseInt(document.getElementById('calIn').value) || 0;
            if(editIndex > -1) dailyFoods[editIndex] = {name: n, cal: c};
            else dailyFoods.push({name: n, cal: c});
            editIndex = -1;
            document.getElementById('foodIn').value = "";
            document.getElementById('calIn').value = "";
            document.getElementById('foodBtn').innerText = "Âä†";
            updateFoodUI();
        }

        function updateFoodUI() {
            const list = document.getElementById('foodList');
            let total = 0;
            list.innerHTML = dailyFoods.map((f, i) => {
                total += f.cal;
                return `<div class="flex justify-between items-center bg-gray-50/50 p-4 rounded-2xl border border-gray-50">
                    <span class="text-xs font-bold">${f.name} <b class="text-orange-500 ml-2">${f.cal}</b></span>
                    <div class="flex gap-4">
                        <button onclick="editF(${i})" class="text-blue-400 text-xs font-black">Êîπ</button>
                        <button onclick="delF(${i})" class="text-pink-300 text-xs font-black">Âà™</button>
                    </div>
                </div>`;
            }).join('');
            document.getElementById('modalDayTotal').innerText = total;
        }

        function editF(i) {
            editIndex = i;
            document.getElementById('foodIn').value = dailyFoods[i].name;
            document.getElementById('calIn').value = dailyFoods[i].cal;
            document.getElementById('foodBtn').innerText = "Á¢∫Ë™ç";
            document.getElementById('foodIn').focus();
        }

        function delF(i) { dailyFoods.splice(i, 1); updateFoodUI(); }

        function calculateWeightDiff() {
            const w1 = parseFloat(document.getElementById('w1').value);
            const w2 = parseFloat(document.getElementById('w2').value);
            const diffEl = document.getElementById('weightDiff');
            if(w1 && w2) {
                const diff = (w2 - w1).toFixed(1);
                diffEl.innerText = `‰ªäÊó•Ê≥¢Âãï: ${diff > 0 ? '+' : ''}${diff} kg`;
            } else { diffEl.innerText = `Ê≥¢Âãï: --`; }
        }

        document.getElementById('w1').oninput = calculateWeightDiff;
        document.getElementById('w2').oninput = calculateWeightDiff;

        function filterEx() {
            const q = document.getElementById('exSearch').value.toLowerCase();
            const list = document.getElementById('exList');
            const filtered = exercises.filter(ex => ex.toLowerCase().includes(q));
            
            list.innerHTML = filtered.map(ex => {
                const [n, p] = ex.split('.');
                return `<div class="flex justify-between items-center p-4 bg-white border border-pink-50 rounded-[20px] shadow-sm">
                    <div class="text-xs"><b class="text-gray-700">${n}</b><br><span class="text-pink-300 text-[9px] uppercase font-bold">${p}</span></div>
                    <div class="flex gap-2 items-center text-xs"><input type="number" placeholder="‰∏ã" class="w-12 p-2 bg-pink-50 rounded-lg text-center font-bold">x<input type="number" placeholder="ÁµÑ" class="w-12 p-2 bg-pink-50 rounded-lg text-center font-bold"></div>
                </div>`;
            }).join('');
        }

        function finalSave() {
            const totalCal = dailyFoods.reduce((s, f) => s + f.cal, 0);
            const data = {
                totalCal, foods: dailyFoods,
                w1: document.getElementById('w1').value,
                w2: document.getElementById('w2').value,
                t1: document.getElementById('t1').value,
                t2: document.getElementById('t2').value,
                water: document.getElementById('waterIn').value
            };
            localStorage.setItem('health_' + activeDate, JSON.stringify(data));
            if(document.getElementById('pCheck').checked) localStorage.setItem('period_start', activeDate);
            else if(localStorage.getItem('period_start') === activeDate) localStorage.removeItem('period_start');
            closeModal(); renderCalendar(); updateTopUI();
        }

        function closeModal() {
            document.getElementById('recordModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            activeDate = "";
        }

        function handleOverlayClick(e) { if(e.target.id === 'recordModal') closeModal(); }

        function updateTopUI() {
            const todayStr = new Date().toISOString().split('T')[0];
            const data = JSON.parse(localStorage.getItem('health_' + todayStr)) || {};
            const periodStart = localStorage.getItem('period_start');
            let tdee = 1800;
            if(periodStart) {
                const diff = (new Date(todayStr) - new Date(periodStart)) / (1000*60*60*24);
                if(diff >= 0 && diff < 7) tdee += 200;
            }
            const remain = tdee - (data.totalCal || 0);
            document.getElementById('topRemain').innerText = remain + " kcal";
            document.getElementById('topCurrentWeight').innerText = (data.w1 || "--") + " kg";
            
            const adEl = document.getElementById('topAdvice');
            if(remain > 800) adEl.innerText = "üåü È†êÁÆóË∂ÖÂ§öÔºÅ‰ªäÂ§©ÂèØ‰ª•ÂêÉÂÄãÂ∞èÁîúÈªûÁçéÂãµËá™Â∑±Âî∑„ÄÇ";
            else if(remain > 400) adEl.innerText = "ü•ó È†êÁÆóÈÅ©‰∏≠ÔºåÊôöÈ§êÂêÉÊ∏ÖÊ∑°ÈªûÂ∞±ÂÆåÁæé‰∫ÜÔºÅ";
            else if(remain > 0) adEl.innerText = "üçé È†êÁÆóÂø´Âà∞Â∫ï‰∫ÜÔºå‰∏ã‰∏ÄÈ§êÂª∫Ë≠∞Âè™ÂêÉËî¨ËèúËõãÁôΩË≥™„ÄÇ";
            else adEl.innerText = "‚åõ Â∑≤ÈÅîÊ®ôÔºåÊòéÂ§©ÂÜçÊé•ÂÜçÂé≤ÔºåÂ§öÂñùÈªûÊ∞¥ÂêßÔºÅ";
        }

        function changeMonth(s) {
            currentMonth += s;
            if(currentMonth > 11) { currentMonth = 0; currentYear++; }
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }
    </script>
</body>
</html>

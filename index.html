<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„ªé›…ç®¡å®¶ v5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --soft-bg: #fffbfb; --accent-red: #ff4d6d; --date-text: #5a4a4a; --exercise-yellow: #fcd34d; }
        body { background-color: var(--soft-bg); font-family: -apple-system, sans-serif; overflow-x: hidden; }
        /* å¾¹åº•é–å®šèƒŒæ™¯ */
        body.modal-open { position: fixed; width: 100%; height: 100%; overflow: hidden; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell { min-height: 90px; background: white; border-radius: 20px; border: 1px solid #fceef0; position: relative; transition: 0.3s; }
        .today-border { border: 2px solid var(--accent-red) !important; background: #fff5f6; }
        .period-dot { position: absolute; top: 6px; right: 6px; width: 7px; height: 7px; background: #ff8fa3; border-radius: 50%; }
        .exercise-dot { position: absolute; top: 6px; right: 16px; width: 7px; height: 7px; background: var(--exercise-yellow); border-radius: 50%; }
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(80, 50, 50, 0.4); z-index: 100; backdrop-filter: blur(5px); justify-content: center; align-items: flex-end; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: #fff9f8; width: 100%; max-width: 450px; border-radius: 40px 40px 0 0; padding-bottom: env(safe-area-inset-bottom); box-shadow: 0 -10px 30px rgba(0,0,0,0.1); height: 85vh; display: flex; flex-direction: column; }
        .estimate-tag { cursor: pointer; background: #fdf2f2; color: #cc7a7a; padding: 6px 14px; border-radius: 12px; font-size: 11px; margin: 4px; border: 1px solid #f5e1e1; }
        .btn-milk-tea { background-color: #dcbfa6; color: white; }
    </style>
</head>
<body class="text-gray-700">

    <div class="max-w-md mx-auto min-h-screen bg-white">
        <div class="p-8 bg-gradient-to-b from-[#fdf0f0] to-white rounded-b-[60px]">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h1 class="text-2xl font-black text-[#8b5e5e] tracking-tight">Health Diary</h1>
                    <p id="topDate" class="text-[10px] text-pink-300 font-bold uppercase mt-1"></p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-pink-300 font-black mb-1">CURRENT WEIGHT</p>
                    <p id="topCurrentWeight" class="text-3xl font-black text-[#5a4a4a]">--</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/90 p-4 rounded-[25px] shadow-sm border border-pink-50">
                    <p class="text-[10px] text-pink-400 font-bold">å‰©é¤˜ç†±é‡</p>
                    <p id="topRemain" class="text-xl font-black text-orange-400">--</p>
                </div>
                <div class="bg-[#fdf9f6] p-4 rounded-[25px] flex items-center justify-center italic text-[10px] text-[#8b5e5e]">
                    <span id="topAdvice">è¼‰å…¥å»ºè­°ä¸­...</span>
                </div>
            </div>
        </div>

        <div class="p-5">
            <div class="flex justify-between items-center px-4 mb-6">
                <button onclick="changeMonth(-1)" class="text-pink-200 text-xl">â—€</button>
                <h2 id="monthTitle" class="font-black text-[#5a4a4a] text-lg"></h2>
                <button onclick="changeMonth(1)" class="text-pink-200 text-xl">â–¶</button>
            </div>
            <div class="calendar-grid text-center text-[10px] text-pink-200 font-black mb-4">
                <div>SUN</div><div>MON</div><div>TUE</div><div>WED</div><div>THU</div><div>FRI</div><div>SAT</div>
            </div>
            <div id="calendarBody" class="calendar-grid"></div>
        </div>
    </div>

    <div id="recordModal" class="modal-overlay" onclick="handleOverlayClick(event)">
        <div class="modal-content animate-slide-up">
            <div class="p-6 flex justify-between items-center">
                <h3 id="modalDateTitle" class="font-black text-[#8b5e5e] text-xl"></h3>
                <button onclick="closeModal()" class="w-10 h-10 bg-white rounded-full text-pink-300 shadow-sm font-bold">âœ•</button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 space-y-8">
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <label class="font-black text-[#8b5e5e]">ğŸª é£²é£Ÿèˆ‡ç†±é‡</label>
                        <span id="modalDayTotal" class="text-xl font-black text-orange-400">0</span>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="foodIn" oninput="showEstimate(this.value)" placeholder="æ‰¾æ‰¾çœ‹ç†±é‡..." class="flex-1 p-4 bg-white rounded-2xl text-sm border-none shadow-sm">
                        <input type="number" id="calIn" placeholder="kcal" class="w-24 p-4 bg-white rounded-2xl text-sm border-none shadow-sm">
                        <button onclick="saveFood()" id="foodBtn" class="btn-milk-tea px-6 rounded-2xl font-bold">åŠ </button>
                    </div>
                    <div id="estimateBox" class="flex flex-wrap"></div>
                    <div id="foodList" class="space-y-2"></div>
                </div>

                <div class="p-5 bg-white rounded-[30px] shadow-sm border border-pink-50">
                    <div class="flex justify-between items-center mb-4">
                        <label class="font-black text-[#8b5e5e]">âš–ï¸ é«”é‡ç´€éŒ„</label>
                        <button onclick="toggleTimeEdit()" class="text-[10px] text-pink-300 underline">ä¿®æ”¹æ™‚é–“</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <span class="text-[9px] text-pink-200 font-bold block mb-1">èµ·åºŠç©ºè…¹</span>
                            <input type="time" id="t1" class="hidden w-full text-[10px] mb-1">
                            <input type="number" step="0.1" id="w1" placeholder="kg" class="w-full p-3 bg-[#fdfaf8] rounded-2xl text-center font-black text-lg">
                        </div>
                        <div class="text-center">
                            <span class="text-[9px] text-pink-200 font-bold block mb-1">ç¡å‰ç´€éŒ„</span>
                            <input type="time" id="t2" class="hidden w-full text-[10px] mb-1">
                            <input type="number" step="0.1" id="w2" placeholder="kg" class="w-full p-3 bg-[#fdfaf8] rounded-2xl text-center font-black text-lg">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="p-5 bg-[#fdf2f2] rounded-3xl flex justify-between items-center">
                        <span class="text-xs font-black text-red-400">ğŸˆ ç”Ÿç†æœŸ</span>
                        <input type="checkbox" id="pCheck" class="w-6 h-6 accent-red-400">
                    </div>
                    <div class="p-5 bg-blue-50 rounded-3xl flex justify-between items-center">
                        <span class="text-xs font-black text-blue-400">ğŸ’§ é£²æ°´</span>
                        <input type="number" id="waterIn" placeholder="ml" class="w-16 bg-transparent text-center font-bold">
                    </div>
                </div>

                <div class="space-y-4">
                    <label class="font-black text-[#8b5e5e]">ğŸƒ é‹å‹•ç´€éŒ„ (è¼¸å…¥åç¨±å³éæ¿¾)</label>
                    <input type="text" id="exSearch" oninput="filterEx()" class="w-full p-4 bg-white rounded-2xl text-sm border-none shadow-sm">
                    <div id="exList" class="space-y-2"></div>
                </div>
            </div>
            
            <div class="p-6 bg-white border-t border-gray-50">
                <button onclick="finalSave()" class="w-full btn-milk-tea py-5 rounded-[25px] font-black shadow-lg">å„²å­˜ä»Šæ—¥æ•¸æ“š</button>
            </div>
        </div>
    </div>

    <script>
        let currentYear, currentMonth, activeDate = "", dailyFoods = [], editIndex = -1;
        
        const calDict = {
            "é‹è²¼":60,"æ°´ç…åŒ…":300,"è‚‰åœ“":350,"ç‡’é¤…æ²¹æ¢":500,"é£¯ç³°":450,"èšµä»”ç…":500,"è‚‰ç‡¥é£¯":450,"ç‰›è‚‰éºµ":650,"å¤§éº¥å…‹":530,"ä¸­è–¯":330,"éº¥å…‹é›å¡Š":200,"æ’éª¨ä¾¿ç•¶":850,"é›è…¿ä¾¿ç•¶":750,"æ’éª¨é£¯":850,"é›è‚‰é£¯":450,"çå¥¶":650,"é›æ’":750,"è›‹é¤…":300,"ä¸‰æ˜æ²»":350,"èµ·å¸è›‹ä¸‰æ˜æ²»":420,"æ¼¢å ¡":450,"å¡æ‹‰é›è…¿å ¡":650,"å·§å…‹åŠ›è›‹ç³•":450,"èµ·å¸è›‹ç³•":350,"è è˜¿éºµåŒ…":400,"ç´…è±†éºµåŒ…":320,"åå¸":150,"åšç‰‡":280,"è²æœ":280,"æ‹¿éµ":150,"ç¾©å¤§åˆ©éºµ":600,"å‡±æ’’æ²™æ‹‰":350,"ç´…è±†é¤…":250,"é›è›‹ç³•":200,"å¿…å‹å®¢å–®ç‰‡":300,"ç‚’éºµ":500,"ç‚’é£¯":750,"èšµä»”éºµç·š":400,"æ»·å‘³å°ä»½":300
        };

        const exercises = ["å•éˆ´è² é‡æ·±è¹².è…¿è‡€","å•éˆ´å¤¾èƒ¸.èƒ¸","å•éˆ´åˆ’èˆ¹.èƒŒ","å·¦å³å´æŠ¬è…¿.è…¿","è·ªå¼å‰å¾Œä¿¯è‡¥æ’.è…¹","ä¿¯è‡¥å¾ŒæŠ¬è…¿.è‡€","è…³å¿ƒé–‹åˆ.è…¿","è·ªå§¿å·¦å³æŠ¬è…¿.è…°è…¹","è·ªå§¿å¾ŒæŠ¬è…¿(ç›´).ä¸‹è‡€","è·ªå§¿å½æ›²æŠ¬è…¿.ä¸Šè‡€","å•éˆ´wå¤–æ¨.æ‰‹è‡‚","è‡€æ©‹.è‡€","å•éˆ´å´å¹³èˆ‰.è‚©","å•éˆ´ç¡¬æ‹‰.è‡€","å½ˆåŠ›å¸¶å‰å¾Œç¹è‚©.è‚©èƒŒ","å½ˆåŠ›å¸¶é«˜ä½ä¸‹æ‹‰.è‚©èƒŒ","å½ˆåŠ›å¸¶å·¦å³å´æ‹‰.æ‰‹èƒ¸","å·¦å³è…¿åˆ†è¹².è‡€","è…³å°–äº¤å‰é»åœ°.è…¹","äº¤æ›¿æ”¶è…¿.è…¹","å±ˆè†æ²è…¹.è…¹","ç›´è…¿æ²è…¹.è…¹","è‡ªè¡Œè»Šæ²è…¹.è…¹","å‰ªåˆ€è…¿.è…¹"];

        window.onload = () => {
            const now = new Date();
            currentYear = now.getFullYear();
            currentMonth = now.getMonth();
            renderCalendar();
            updateTopUI();
        };

        function renderCalendar() {
            const body = document.getElementById('calendarBody');
            body.innerHTML = '';
            document.getElementById('monthTitle').innerText = `${currentYear}å¹´ ${currentMonth + 1}æœˆ`;
            document.getElementById('topDate').innerText = new Date().toDateString();
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const periodStart = localStorage.getItem('period_start');
            const todayStr = new Date().toISOString().split('T')[0];

            for (let i = 0; i < firstDay; i++) body.innerHTML += `<div></div>`;

            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const data = JSON.parse(localStorage.getItem('health_' + dateStr));
                let classes = 'day-cell p-3 cursor-pointer active:scale-95';
                if(dateStr === todayStr) classes += ' today-border';
                
                let dots = '';
                if(periodStart) {
                    const diff = (new Date(dateStr) - new Date(periodStart)) / (1000*60*60*24);
                    if(diff >= 0 && diff < 7) dots += `<div class="period-dot"></div>`;
                }
                if(data && data.hasEx) dots += `<div class="exercise-dot"></div>`;

                body.innerHTML += `<div class="${classes}" onclick="openModal('${dateStr}')">
                    <span class="text-[#5a4a4a] font-black text-xs">${d}</span>
                    ${data && data.totalCal ? `<div class="text-[9px] text-orange-400 font-black mt-2 leading-none">${data.totalCal}k</div>` : ''}
                    ${data && data.w1 ? `<div class="text-[9px] text-pink-300 font-bold mt-1 leading-none">${data.w1}kg</div>` : ''}
                    ${dots}
                </div>`;
            }
        }

        function openModal(date) {
            activeDate = date;
            document.getElementById('modalDateTitle').innerText = date;
            const data = JSON.parse(localStorage.getItem('health_' + date)) || {};
            document.getElementById('w1').value = data.w1 || '';
            document.getElementById('w2').value = data.w2 || '';
            document.getElementById('t1').value = data.t1 || '08:00';
            document.getElementById('t2').value = data.t2 || '22:30';
            document.getElementById('waterIn').value = data.water || '';
            document.getElementById('pCheck').checked = (localStorage.getItem('period_start') === date);
            dailyFoods = data.foods || [];
            updateFoodUI();
            filterEx(); 
            document.getElementById('recordModal').classList.add('active');
            document.body.classList.add('modal-open');
        }

        function closeModal() {
            document.getElementById('recordModal').classList.remove('active');
            document.body.classList.remove('modal-open');
            activeDate = "";
        }

        function handleOverlayClick(e) { if(e.target.id === 'recordModal') closeModal(); }

        function showEstimate(val) {
            const box = document.getElementById('estimateBox');
            box.innerHTML = '';
            if(!val) return;
            Object.keys(calDict).filter(k => k.includes(val)).slice(0, 6).forEach(m => {
                box.innerHTML += `<div class="estimate-tag" onclick="useEst('${m}', ${calDict[m]})">${m} ${calDict[m]}k</div>`;
            });
        }

        function useEst(n, c) {
            document.getElementById('foodIn').value = n;
            document.getElementById('calIn').value = c;
            document.getElementById('estimateBox').innerHTML = '';
        }

        function saveFood() {
            const n = document.getElementById('foodIn').value || "é£Ÿç‰©";
            const c = parseInt(document.getElementById('calIn').value) || 0;
            if(editIndex > -1) dailyFoods[editIndex] = {name: n, cal: c};
            else dailyFoods.push({name: n, cal: c});
            editIndex = -1;
            document.getElementById('foodIn').value = "";
            document.getElementById('calIn').value = "";
            document.getElementById('foodBtn').innerText = "åŠ ";
            updateFoodUI();
        }

        function updateFoodUI() {
            const list = document.getElementById('foodList');
            let total = 0;
            list.innerHTML = dailyFoods.map((f, i) => {
                total += f.cal;
                return `<div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-pink-50 text-xs">
                    <span class="font-bold text-[#8b5e5e]">${f.name} <b class="text-orange-400 ml-2">${f.cal}k</b></span>
                    <button onclick="delF(${i})" class="text-pink-200 font-black">âœ•</button>
                </div>`;
            }).join('');
            document.getElementById('modalDayTotal').innerText = total;
        }

        function delF(i) { dailyFoods.splice(i, 1); updateFoodUI(); }

        function toggleTimeEdit() {
            document.getElementById('t1').classList.toggle('hidden');
            document.getElementById('t2').classList.toggle('hidden');
        }

        function filterEx() {
            const q = document.getElementById('exSearch').value.toLowerCase();
            const list = document.getElementById('exList');
            list.innerHTML = exercises.filter(ex => ex.toLowerCase().includes(q)).map(ex => {
                const [n, p] = ex.split('.');
                return `<div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-pink-50">
                    <div class="text-[10px]"><b class="text-[#8b5e5e]">${n}</b><br><span class="text-pink-200 font-bold">${p}</span></div>
                    <div class="flex gap-2 items-center"><input type="number" placeholder="çµ„" class="w-10 p-1 bg-[#fdfaf8] rounded text-center text-xs"></div>
                </div>`;
            }).join('');
        }

        function finalSave() {
            const totalCal = dailyFoods.reduce((s, f) => s + f.cal, 0);
            const data = {
                totalCal, foods: dailyFoods,
                w1: document.getElementById('w1').value,
                w2: document.getElementById('w2').value,
                t1: document.getElementById('t1').value,
                t2: document.getElementById('t2').value,
                water: document.getElementById('waterIn').value,
                hasEx: (document.getElementById('exSearch').value !== "" || dailyFoods.length > 0) // ç°¡å–®é‚è¼¯ï¼šæœ‰è¼¸å…¥å…§å®¹å°±ç®—é‹å‹•
            };
            localStorage.setItem('health_' + activeDate, JSON.stringify(data));
            if(document.getElementById('pCheck').checked) localStorage.setItem('period_start', activeDate);
            else if(localStorage.getItem('period_start') === activeDate) localStorage.removeItem('period_start');
            closeModal(); renderCalendar(); updateTopUI();
        }

        function updateTopUI() {
            const todayStr = new Date().toISOString().split('T')[0];
            const data = JSON.parse(localStorage.getItem('health_' + todayStr)) || {};
            const periodStart = localStorage.getItem('period_start');
            let tdee = 1800;
            if(periodStart) {
                const diff = (new Date(todayStr) - new Date(periodStart)) / (1000*60*60*24);
                if(diff >= 0 && diff < 7) tdee += 200;
            }
            const remain = tdee - (data.totalCal || 0);
            document.getElementById('topRemain').innerText = remain + " kcal";
            document.getElementById('topCurrentWeight').innerText = (data.w1 || "--") + "kg";
            document.getElementById('topAdvice').innerText = remain > 0 ? "åŠ æ²¹ï¼Œä»Šå¤©é‚„å‰©ä¸‹é»é ç®—ï¼" : "ä»Šå¤©å·²ç¶“é”æ¨™å›‰ï¼Œæ—©é»ä¼‘æ¯ã€‚";
        }

        function changeMonth(s) {
            currentMonth += s;
            if(currentMonth > 11) { currentMonth = 0; currentYear++; }
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }
    </script>
</body>
</html>
